<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>用户登陆</title>
	
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="this is my page">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    
    <!--  <link rel="stylesheet" href="http://res.wx.qq.com/open/libs/weui/0.4.0/weui.min.css"> -->
    <link rel="stylesheet" href="css/weui.css"/>
    <link rel="stylesheet" href="css/example.css"/>

    <link rel="stylesheet" type="text/css" href="http://hovertree.com/texiao/mobile/5/hovertreebottom.css" media="all">
    <link rel="stylesheet" type="text/css" href="css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="css/htmleaf-demo.css">
    <link rel="stylesheet" type="text/css" href="assets/less/unlock.css">
    <link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/htmleaf-demo.css">
    <link rel="stylesheet" type="text/css" href="css/verify.css">
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    
    <style>


        #myTab li{
            /*border: 1px solid red;*/
        }

        .an{
            /*background-color: #e7e7e7;*/
            color: #b7b7b7;

        }
        .message{
            font-size: 12px;
            color: #ff4711;
        }
    </style>
</head>
<body>

<div class="page__hd">
    <h1 class="page__title">点餐系统</h1>
    <p class="page__desc">登录</p>
</div>




<ul id="myTab" class="nav nav-tabs">
    <li class="active">
        <a href="#home" id="NumberBtn" data-toggle="tab">
            账号登录
        </a>
    </li>
    <li><a href="#ios" id="MessageBtn" data-toggle="tab">短信登录</a></li>

</ul>





            <div id="wl_content">

         <!--账号密码登陆-->
                <div class="weui-cells weui-cells_form" id="NumberForm">

                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">账号</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input"

                                   id="num_name"
                                   v-model="name" type="text" placeholder="请输入账号"
                                   required
                            />
                        </div>
                        <p class="message" hidden>最少6位</p>
                    </div>


                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">密码</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input"
                                   v-model="password"
                                   id="num_pwd"
                                   type="password"  placeholder="请输入密码"/>
                        </div>
                        <p class="message" hidden>最少6位</p>
                    </div>


                    <div class="weui-btn-area">
                        <a class="weui-btn weui-btn_primary" @click="wl_num_go()" href="javascript:">确定</a>
                    </div>

                </div>



                <!--短信登陆      -->


                <div class="weui-cells weui-cells_form" id="messageForm" style="display: none">


                    <div class="weui-cell weui-cell_select weui-cell_select-before">
                        <div class="weui-cell__hd">
                            <select class="weui-select" name="select2">
                                <option value="1">+86</option>
                                <option value="2">+80</option>
                                <option value="3">+84</option>
                                <option value="4">+87</option>
                            </select>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input"
                                   id="phone"
                                   type="number" v-model="phone"  pattern="[0-9]*" placeholder="请输入号码"/>
                        </div>
                        <p class="message" hidden>请输入正确的手机号</p>
                    </div>


                    <div class="weui-cell weui-cell_vcode">
                        <div class="weui-cell__hd">
                            <label class="weui-label">验证码</label>

                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input"
                                   id="phone_name"
                                   v-model="session"  type="text" placeholder="请输入手机号"/>
                        </div>

                        <div class="weui-cell__ft ">
                            <button class="weui-vcode-btn"  @click="set_code()" id="getcode"><span id="content">获取验证码</span></button>
                        </div>
                    </div>

                    <div class="weui-btn-area">
                        <a class="weui-btn weui-btn_primary" @click="wl_message_go()" href="javascript:" >确定</a>
                    </div>

                </div>



                <!--公共的分割线-->









                <!-- 微信隐藏的按钮 -->
                <div class="page__bd page__bd_spacing" style="display: none;">
                    <a href="javascript:;" class="weui-btn weui-btn_default" id="showToast">成功提示</a>

                </div>

                <!-- //定义的微信弹框 -->
                <div id="toast" style="display: none;height: 30px;">
                    <div class="weui-mask_transparent"></div>
                    <div class="weui-toast">
                        <i class="weui-icon-success-no-circle weui-icon_toast"></i>
                        <p class="weui-toast__content">账号或密码错误!</p>
                    </div>
                </div>


            </div>









</body>
<script src="js/jquery-2.1.1.min.js"></script>
<script src="js/zepto.min.js"></script>
<script src="js/vue.js"></script>
<script type="text/javascript" src="js/jweixin-1.0.0.js"></script>
<script src="js/weui.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="http://hovertree.com/texiao/mobile/5/hovertreebottom.js"></script>

<script type="text/javascript"></script>

<script type="text/javascript" src="js/verify.js" ></script>
<script type="text/javascript" src="js/jquery.md5.js"></script>
<script>

    var sessionCode=10;
    $(function(){
    	
        var $toast = $('#toast');
        $('#showToast').on('click', function(){

            if ($toast.css('display') != 'none') return;

            $toast.fadeIn(100);
            setTimeout(function () {
                $toast.fadeOut(100);
            }, 2000);
        });



        $("#NumberBtn").click(function () {

            $("#messageForm").hide();
            $("#NumberForm").show();
            $("#NumberForm").fadeIn();
        })

        $("#MessageBtn").click(function () {

            $("#NumberForm").hide();
            $("#messageForm").show();
            $("#messageForm").fadeIn();
        })

        $("#num_name").blur(function () {
            var str = $("#num_name").val();
            var ret = /^\w{3,90}$/;
            if(ret.test(str)){
                $(this).parent().next().hide();
            }else{

                $(this).parent().next().show();


            }
        })


        $("#num_pwd").blur(function () {
            var str = $("#num_pwd").val();
            var ret = /^\w{6,20}$/;
            if(ret.test(str)){
                $(this).parent().next().hide();
            }else{

                $(this).parent().next().show();


            }
        })

        $("#phone").blur(function () {

            var str = $("#phone").val();
            var ret =/^1[3,5,8]\d{9}$/;
            if(ret.test(str)){
                $(this).parent().next().hide();
            }else{

                $(this).parent().next().show();


            }
        })




    });


</script>


<script type="text/javascript">
    var app=new Vue({
        el:"#wl_content",
        data:{
            "name":"",
            "password":"",
            "message":"",
            "phone":"",
            "session":"",
            "isok":false,
            "isclick":false

        },
        methods:{

            lan(name,password){

                var ret = /^\w{5,20}$/;
                if(!ret.test(name)){
                   return false;
                }


                var ret = /^\w{5,20}$/;
                if(!ret.test(password)){
                    return false;
                }
            },


            wl_num_go(){
				var zhi= this.$options.methods.lan(this.name,this.password);
				if(zhi==false){
					$(".message").show();
					return ;
				}
                
               

                if(this.name=="" ||this.password==""){
                    $(".weui-toast__content").html("请填写信息!");
                    $("#showToast").click();
                    return;
                }
//                alert(1);
                let data={"account":this.name,"password":this.password};

                console.log(data);
                
                this.password=$.md5(this.password);
                console.log(this.password);
                axios.post("LoginServlet?type=0&account="+this.name+"&password="+this.password).then(response=>{
                	console.log(response.data.status);
                	if(response.data.status==1){
                     location.href="UserInfo.html";
               		  }else{
                 //登陆失败弹出狂战
                 	 $(".weui-toast__content").html("账号或者密码错误!");
                     $("#showToast").click();
                     this.password="";
                	 }
                	
                })
                

            },

            wl_message_go(){
            console.log("sessioncode"+sessionCode);
            console.log("session"+this.session);
            console.log("status"+this.isclick);
 
				if(this.isclick==false){
					$(".message").show();
					return;
				}
                var ret =/^1[3,5,8]\d{9}$/;
                if(!ret.test(this.phone)){
					$(".message").show();
                    console.log("这特么")
                    return;
                }
                
                

                console.log(this.session);
                console.log(sessionCode);
                if(this.session!=sessionCode){
                    $(".weui-toast__content").html("验证码不对!");
                    $("#showToast").click();
                    return;
                }else{
                
                console.log(this.phone);
                //登陆成功了ajax一个添加服务器端session的请求,到用户页面要用的
                axios.get("LoginServlet?type=addSession&phone="+this.phone+"&code="+this.session).then(response=>{
                	
                	var temp=response.data.status;
                	if(temp==1){
                		//登陆成功!
                		location.href="message.html?message=2";
                		
                	}else{
                		 $(".weui-toast__content").html("登陆失败!");
                         $("#showToast").click();
                         return;
                	}
                	
                	
                
                })
                
                
                
                   
                	
                }



            },

//发送验证码
            set_code(){

                if(this.isok==true){
					return;
				}
                var ret =/^1\d{9,10}$/;
                if(!ret.test(this.phone)){
                	 $(".weui-toast__content").html("请输入正确的手机号码!");
                     $("#showToast").click();
                     return;
                }                
                
				this.isclick=true;
			console.log(this.phone);
                if(this.phone==""){
                    $(".weui-toast__content").html("请输入手机号码!");
                    $("#showToast").click();
                    return;
                }
                
				var tempisok=false;
				axios.get("LoginServlet?type=phone&phone="+this.phone).then(response=>{
// 					console.log(response.data.status);
					var isok=response.data.status;
					if(isok==1){
						$(".weui-toast__content").html("这个手机号没有被注册过了!");
	                    $("#showToast").click();
	                    return;
					}else{
						
						this.isok=true;
			               $("#getcode").css("color","#b7b7b7")

			 					axios.get("RegistServlet?opr=setcode&phone="+this.phone).then(response=>{
								console.log(response);
								var code=response.data.code;
								sessionCode=code;
								console.log(sessionCode);
			                    $("#showToast").click();
			                    $(".weui-toast__content").html("验证码发送成功!");
			                    var timelong = 60;
			                    
			                    $("#getcode").addClass("an");
			                    var time = setInterval(function () {
			                        timelong--;
			                        $("#content").html(timelong+"秒后重试");
			                        $("#getcode").attr("disabled","true");
			                        if(timelong<2){
			                            clearInterval(time);
			                            $("#getcode").attr("disabled","false");
			                            $("#getcode").removeClass("an");
			                            $("#content").html("获取验证码");
			                            $("#getcode").css("color","green");
			                            this.isok=false;
			                        }

			                    }, 1000)


			                })
					}
					
				}).catch(function (error) {
					location.href="error.html?message=123123";
				    console.log(error);
				    return;
				  });
				console.log(tempisok);
				if(tempisok==false){
					
					console.log("怎么可能在此出错!")
					return;
					
				}
               
               



            }
        }






    })



</script>


</html>